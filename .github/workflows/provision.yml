name: CI

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup CI environment
        id: setup
        uses: ./
        with:
          catalog_image: 'quay.io/rhoai/rhoai-fbc-fragment:rhoai-3.2'
          env: |
            ENVIRONMENT=production
            DEPLOY_DATE=${{ github.event.head_commit.timestamp }}
      
      - name: Provision
        shell: bash
        env:
          ENV_FILE: ${{ steps.setup.outputs.env_file }}
        run: |
          chmod +x ${{ steps.setup.outputs.scripts_dir }}/provision.sh
          ${{ steps.setup.outputs.scripts_dir }}/provision.sh
      
      - name: Test
        shell: bash
        env:
          ENV_FILE: ${{ steps.setup.outputs.env_file }}
        run: |
          chmod +x ${{ steps.setup.outputs.scripts_dir }}/test.sh
          ${{ steps.setup.outputs.scripts_dir }}/test.sh
      
      - name: Cleanup
        if: always()
        shell: bash
        env:
          ENV_FILE: ${{ steps.setup.outputs.env_file }}
        run: |
          chmod +x ${{ steps.setup.outputs.scripts_dir }}/cleanup.sh
          ${{ steps.setup.outputs.scripts_dir }}/cleanup.sh
